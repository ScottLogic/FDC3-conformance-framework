<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Title</title>
  <link rel="stylesheet" href="index.css" />
</head>

<body>
  <p>Conformance Framework Mock App</p>
  <p>This app is only used by the conformance framework for test purposes</p>
  <p></p>
  <p id="context"></p>
  <script>
    let firedOnce = false;

    const fdc3ApiCalls = async (context) => {
      await window.fdc3.leaveCurrentChannel();
      switch (context.reverseFunctionCallOrder) {
        case false:
          const testChannel = await joinChannel(context.joinAppChannel);
          broadcast(context, testChannel);
          break;
        case true:
          await broadcast(context.contextBroadcasts);
          joinChannel(context.joinAppChannel);
          break;
      }
    }

    const joinChannel = async (useAppChannel) => {
      if (useAppChannel) {
        return await joinAppChannel();
        document.getElementById("context").innerHTML += "Joined app channel/ ";
      } else {
        await joinSystemChannel();
        document.getElementById("context").innerHTML += "Joined user channel/ ";
      }
    }

    const broadcast = async (context, testChannel) => {
      if(testChannel === undefined){
        await systemBroadcast(context.contextBroadcasts);
      }else{
        await appChannelBroadcast(context, testChannel);
      }
    }

    //Channels app joins channel 1
    const joinSystemChannel = async () => {
      const channels = await window.fdc3.getSystemChannels();
      if (channels.length > 0) {
        try {
          await window.fdc3.joinChannel(channels[0].id);
        } catch (ex) {
          throw new Error("Error while calling joinChannel in app B: " + (ex.message ?? ex))
        }
      } else {
        throw new Error("No system channels available for app B");
      }
    }

    //Channels app joins test-channel
    const joinAppChannel = async () => {
      try {
        return await fdc3.getOrCreateChannel("test-channel");
      } catch (ex) {
        throw new Error("Error while joining test-channel in channels app: " + (ex.message ?? ex))
      }
    }

    //Broadcast from channels app
    const systemBroadcast = async (contextBroadcasts) => {
      for (const context in contextBroadcasts) {
        if (contextBroadcasts[context]) {
          await window.fdc3.broadcast({
            "type": `fdc3.${context}`
          });
          document.getElementById("context").innerHTML += `System broadcast: fdc3.${context}/ `;
        }
      };
    }

    const appChannelBroadcast = async (context, testChannel) => {
        let items = 1;
        if (context.broadcastMultipleItems) {
          items = 2;
        }

        try {
          for (const systemContext in context.contextBroadcasts) {
            if (context.contextBroadcasts[systemContext]) {
              for (let i = 0; i < items; i++) {
                await testChannel.broadcast({
                  "type": `fdc3.${systemContext}`,
                  "name": `History-item-${i+1}`
                });
                document.getElementById("context").innerHTML += `App channel broadcast: fdc3.${systemContext} -- History-item-${i+1}/ `;
              }
            }
          };
        } catch {
          throw new Error("Error attempting to broadcast to app channel");
        }
      }
    
    //Retrieve context
    window.fdc3.addContextListener(
      "channelsAppContext",
      (context) => {
        if (firedOnce === false) {
          firedOnce = true;
          fdc3ApiCalls(context);
        }
      });

      setupCloseListener(window.fdc3);
  </script>
</body>

</html>
